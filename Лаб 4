import sqlite3
from difflib import get_close_matches

conn = sqlite3.connect("chatbot.db")
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS knowledge (
    question TEXT,
    answer TEXT
)
""")
conn.commit()

data = [
    ("привет", "Здравствуйте!"),
    ("как тебя зовут", "Я чат-бот."),
    ("что ты умеешь", "Я ищу ответы в базе данных."),
    ("абиш получит хорошую оценку", "Конечно, Абиш получит хорошую оценку!"),
    ("пока", "До свидания!")
]

for question, answer in data:
    cursor.execute("SELECT * FROM knowledge WHERE question = ?", (question,))
    if not cursor.fetchone():
        cursor.execute("INSERT INTO knowledge VALUES (?, ?)", (question, answer))

conn.commit()

chat_history = []

def find_answer(user_message):
    message = user_message.lower().strip().replace("?", "")
    cursor.execute("SELECT question, answer FROM knowledge")
    rows = cursor.fetchall()
    questions = [row[0] for row in rows]
    matches = get_close_matches(message, questions, n=1, cutoff=0.6)
    if matches:
        for row in rows:
            if row[0] == matches[0]:
                return row[1]
    return "Извините, я не знаю ответа на этот вопрос."

print("Чат запущен. Введите 'выход' для завершения.\n")

while True:
    user_input = input("Вы: ")
    if user_input.lower() == "выход":
        break
    bot_response = find_answer(user_input)
    chat_history.append(("Вы", user_input))
    chat_history.append(("Бот", bot_response))
    print("Бот:", bot_response)

print("\nИстория переписки:")
for sender, message in chat_history:
    print(f"{sender}: {message}")

conn.close()
